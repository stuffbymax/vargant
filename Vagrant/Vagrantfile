Vagrant.configure("2") do |config|
  # Specify the base box image to use (Ubuntu Jammy 22.04 LTS 64-bit)
  config.vm.box = "ubuntu/jammy64"

  # Configure the VM to use a public network with DHCP and automatically set the default route
  config.vm.network "public_network", use_dhcp_assigned_default_route: true

  # Sync a folder from the host ("./shared/") to the guest VM at "/shared"
  config.vm.synced_folder "./shared/", "/shared"

  # Provision the VM with a shell script (runs as non-root user)
  config.vm.provision "shell", privileged: false, inline: <<-SHELL
    # Update package lists and upgrade installed packages
    sudo apt update
    sudo apt upgrade -y

    # Install necessary packages
    sudo apt install -y nginx lynx vim git wget unzip dh-make devscripts

    # Find the first private IPv4 address (10.1.x.x or 192.168.x.x)
    IPADDR=$(ip -4 a | grep inet | awk '{print $2}' | cut -d "/" -f 1 | grep -E "10\\.1\\.|192\\.168\\." | head -n 1)

    # If no suitable IP address was found, print error and exit
    if [ -z "$IPADDR" ]; then
      echo "No suitable IP found!"
      exit 1
    fi

    # Print the selected IP address
    echo -e "Your IP is \\e[42m$IPADDR\\e[0m"

    # Create a directory for the website files
    sudo mkdir -p /var/www/$IPADDR/html

    # Copy website files from the shared "nasa" directory
    sudo cp -r /shared/nasa/* /var/www/$IPADDR/html/

    # Create an Nginx site configuration
    sudo tee /etc/nginx/sites-available/$IPADDR > /dev/null <<EOF
server {
    listen 80;
    listen [::]:80;

    root /var/www/$IPADDR/html;
    index index.html index.htm index.nginx-debian.html;

    server_name $IPADDR www.$IPADDR;

    location / {
        try_files \\\$uri \\\$uri/ =404;
    }
}
EOF

    # Set ownership and permissions
    sudo chown -R vagrant:vagrant /var/www/$IPADDR/html
    sudo chmod -R 755 /var/www/$IPADDR

    # Enable the Nginx site
    sudo ln -sf /etc/nginx/sites-available/$IPADDR /etc/nginx/sites-enabled/

    # Restart Nginx to apply changes
    sudo systemctl restart nginx
  SHELL
end
