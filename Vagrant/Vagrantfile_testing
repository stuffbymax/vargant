Vagrant.configure("2") do |config|
  # Use Ubuntu Jammy 22.04 (64-bit) as the base box
  config.vm.box = "ubuntu/jammy64"

  # Use a public network with DHCP and auto-assign the default route
  config.vm.network "public_network", use_dhcp_assigned_default_route: true

  # Sync the local ./shared/ directory to the guest VM at /shared
  config.vm.synced_folder "./shared/", "/shared"

  # Provision the VM with a shell script (run as non-root user)
  config.vm.provision "shell", privileged: false, inline: <<-SHELL
    # Update and upgrade system packages
    sudo apt update
    sudo apt upgrade -y

    # Install required packages
    sudo apt install -y nginx lynx vim git wget unzip dh-make devscripts

    # Extract the first private IPv4 address (in 10.1.x.x or 192.168.x.x ranges)
    IPADDR=$(ip -4 a | grep inet | awk '{print $2}' | cut -d "/" -f 1 | grep -E "10\\.1\\.|192\\.168\\." | head -n 1)

    # Exit if no suitable IP was found
    if [ -z "$IPADDR" ]; then
      echo "No suitable IP found!"
      exit 1
    fi

    echo "Your IP is $IPADDR"

    # Define the directory as /var/www/<IP>/nasa
    TARGET_DIR="/var/www/$IPADDR/nasa"

    # Create the target directory
    sudo mkdir -p $TARGET_DIR

    # Copy website files from shared/nasa to the target directory
    sudo cp -r /shared/nasa/* $TARGET_DIR/

    # Create an Nginx config for the IP-based virtual host
    sudo tee /etc/nginx/sites-available/$IPADDR > /dev/null <<EOF
server {
    listen 80;
    listen [::]:80;

    # Root is the new path /var/www/<IP>/nasa
    root $TARGET_DIR;
    index index.html index.htm index.nginx-debian.html;

    server_name $IPADDR www.$IPADDR;

    location / {
        try_files \$uri \$uri/ =404;
    }
}
EOF

    # Set ownership and permissions
    sudo chown -R vagrant:vagrant $TARGET_DIR
    sudo chmod -R 755 /var/www/$IPADDR

    # Enable the Nginx site and reload the server
    sudo ln -sf /etc/nginx/sites-available/$IPADDR /etc/nginx/sites-enabled/
    sudo systemctl restart nginx
  SHELL
end
